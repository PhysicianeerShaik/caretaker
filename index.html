<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- iOS add-to-home-screen friendliness -->
<meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="HomePAL Care Tracker" />
  <meta name="theme-color" content="#0d9488" />
  <meta name="description" content="HomePAL - Professional home care tracking for patients, families, and care teams." />

  <title>HomePAL - Care Tracker</title>

<style>
  :root {
      /* HomePAL Professional Healthcare Design System */
      --primary: #0d9488;           /* Teal - trust, care, medical */
      --primary-dark: #0f766e;
      --primary-light: #14b8a6;
      --primary-bg: #ccfbf1;
      --primary-hover: #0f766e;
      
      --secondary: #0891b2;         /* Cyan - complementary */
      --secondary-light: #e0f2fe;
      
      --bg: #f8fafc;                /* Soft white-gray */
      --bg-gradient: linear-gradient(135deg, #f0fdfa 0%, #e0f2fe 100%);
      --card: #ffffff;
      --card-hover: #fafafa;
      
      --text: #0f172a;              /* Deep slate */
      --text-secondary: #475569;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      
      --success: #10b981;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      
      --warning: #f59e0b;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      
      --danger: #ef4444;
      --danger-bg: #fee2e2;
      --danger-border: #f87171;
      --danger-text: #991b1b;
      
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      
      --radius-sm: 0.5rem;
      --radius-md: 0.75rem;
    --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      
      --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
    }

    * {
      box-sizing: border-box;
  }

  body {
      background: var(--bg-gradient);
      background-attachment: fixed;
    color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", "SF Pro Display", Roboto, "Helvetica Neue", sans-serif;
    margin: 0;
      padding: 0;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-xl) var(--spacing-lg);
    display: flex;
    flex-direction: column;
      gap: var(--spacing-xl);
      min-height: 100vh;
    }

    /* ========= Professional Header with Branding ========= */
    .brand-header {
      background: var(--card);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      margin-bottom: var(--spacing-md);
    }

    .brand-logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-lg);
      border-bottom: 2px solid var(--border-light);
    }

    .brand-logo-img {
      width: 256px;
      height: 128px;
      object-fit: contain;
      display: block;
      flex-shrink: 0;
    }

    .brand-logo-text {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.03em;
      margin: 0;
    }

    .brand-tagline {
      color: var(--text-secondary);
      font-size: 0.95rem;
      font-weight: 500;
      margin: 0;
      margin-top: var(--spacing-xs);
  }

  header {
    display: flex;
    flex-direction: column;
      gap: var(--spacing-md);
  }

  header h1 {
      font-size: 1.5rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
      letter-spacing: -0.01em;
  }

  header .subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
    max-width: 700px;
      line-height: 1.6;
  }

  .card {
    background-color: var(--card);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
      border-color: var(--primary-light);
    }

    .card:hover::before {
      opacity: 1;
  }

  .alert-card {
      position: fixed;
      bottom: var(--spacing-lg);
      right: var(--spacing-lg);
      background: linear-gradient(135deg, var(--danger-bg) 0%, #fef2f2 100%);
      border-radius: var(--radius-xl);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-xl);
      border: 2px solid var(--danger-border);
      z-index: 1000;
      max-width: 400px;
      width: calc(100% - 2 * var(--spacing-lg));
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    .alert-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--danger);
    }

    .alert-card.collapsed {
      max-width: 265px;
      padding: var(--spacing-sm) var(--spacing-md);
    }

    .alert-card.collapsed .alert-content {
      display: none;
    }

    .alert-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      gap: var(--spacing-xs);
    }

    .alert-toggle:hover {
      opacity: 0.9;
    }

    .alert-toggle-text {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--danger-text);
      margin: 0;
      flex: 1;
      line-height: 1.3;
    }

    .alert-card.collapsed .alert-toggle-text {
      font-size: 0.75rem;
      line-height: 1.2;
    }

    .alert-arrow {
    font-size: 1rem;
      color: var(--danger-text);
      transition: transform 0.3s ease;
      flex-shrink: 0;
    }

    .alert-card.collapsed .alert-arrow {
      font-size: 0.875rem;
    }

    .alert-card.collapsed .alert-arrow {
      transform: rotate(180deg);
    }

    .alert-content {
      margin-top: var(--spacing-lg);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .alert-title {
      font-size: 1.1rem;
    font-weight: 600;
    color: var(--danger-text);
      margin: 0 0 1rem;
    display: flex;
    align-items: baseline;
      gap: 0.5rem;
    }

    /* Responsive adjustments for alert card */
    @media (max-width: 768px) {
      .alert-card {
        right: var(--spacing-md);
        bottom: var(--spacing-md);
        max-width: calc(100% - 2 * var(--spacing-md));
      }

      .alert-card.collapsed {
        max-width: 200px;
        padding: var(--spacing-xs) var(--spacing-sm);
      }
  }

  .alert-list {
    margin: 0;
      padding-left: 1.5rem;
    color: var(--text);
      font-size: 0.9rem;
      line-height: 1.6;
  }

  .alert-list li {
      margin-bottom: 0.75rem;
  }

  .section-title {
    display: flex;
    align-items: start;
    justify-content: space-between;
      margin-bottom: var(--spacing-lg);
    flex-wrap: wrap;
      row-gap: var(--spacing-md);
      column-gap: var(--spacing-lg);
  }

  .section-left {
    display: flex;
    flex-direction: column;
      gap: var(--spacing-sm);
  }

  .section-left h2 {
      font-size: 1.25rem;
      font-weight: 700;
    color: var(--text);
    margin: 0;
    display: flex;
    align-items: baseline;
      gap: 0.75rem;
      letter-spacing: -0.01em;
  }

  .pill {
      background: var(--primary-bg);
      border: 1px solid var(--primary);
      color: var(--primary-dark);
      font-size: 0.75rem;
      padding: 0.375rem 0.875rem;
    border-radius: 999px;
      font-weight: 600;
      line-height: 1.3;
    white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.05em;
  }

  .tiny-note {
      font-size: 0.8rem;
    color: var(--muted);
      line-height: 1.5;
    font-weight: 400;
  }

  .section-right {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
  }

  .row-buttons {
    display: flex;
    gap: .75rem;
    flex-wrap: wrap;
  }

  button.main-btn {
    flex: 1;
      min-width: calc(50% - 0.5rem);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #ffffff;
    border: 0;
      border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
      padding: 0.875rem 1.5rem;
      line-height: 1.5;
      box-shadow: var(--shadow-md);
    cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    button.main-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    button.main-btn:hover {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    button.main-btn:hover::before {
      left: 100%;
    }

    button.main-btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
  }

  button.sec-btn {
    background-color: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 600;
      line-height: 1.5;
      padding: 0.625rem 1.25rem;
    cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    button.sec-btn:hover {
      background-color: var(--primary-bg);
      border-color: var(--primary-dark);
      color: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
  }

  button.danger-btn {
    background-color: transparent;
    color: var(--danger-text);
      border: 1.5px solid var(--danger-text);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
    font-weight: 500;
      line-height: 1.4;
      padding: 0.5rem 0.75rem;
    cursor: pointer;
      transition: all 0.2s ease;
    }

    button.danger-btn:hover {
      background-color: var(--danger-bg);
  }

  .drawer-card {
    display: none;
    flex-direction: column;
      gap: var(--spacing-xl);
      margin-top: var(--spacing-lg);
      background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-light) 100%);
      border-radius: var(--radius-xl);
      border: 2px solid var(--primary);
      padding: var(--spacing-xl);
      box-shadow: var(--shadow-lg);
    }

  .drawer-card.active {
    display: flex;
  }

  .block-group {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .flex-row-wrap {
    display: flex;
    flex-wrap: wrap;
      column-gap: 1.25rem;
      row-gap: 1.25rem;
      align-items: flex-start;
  }

  .field {
    display: flex;
    flex-direction: column;
      flex: 1 1 200px;
      min-width: 0;
      max-width: 100%;
  }

  .field-can-drop {
      flex: 1 1 180px;
      min-width: 0;
      max-width: 100%;
  }

  .field label {
      font-size: 0.8rem;
    color: var(--muted);
    font-weight: 500;
      line-height: 1.4;
      margin-bottom: 0.5rem;
      word-wrap: break-word;
  }

  input, select, textarea {
    width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    background-color: var(--card);
    color: var(--text);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      padding: 0.875rem 1rem;
      font-size: 0.95rem;
      line-height: 1.5;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
    }

    input:hover,
    select:hover,
    textarea:hover {
      border-color: var(--primary-light);
  }

  input:focus,
  select:focus,
  textarea:focus {
      outline: none;
      border-color: var(--primary);
      background-color: var(--card);
      box-shadow: 0 0 0 4px var(--primary-bg);
  }

  textarea {
      min-height: 4rem;
    resize: vertical;
  }

  .save-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .save-row button {
    flex: 1;
    min-width: calc(50% - .5rem);
  }

  .table-wrapper {
    overflow-x: auto;
      border-radius: var(--radius-xl);
      border: 2px solid var(--border);
      box-shadow: var(--shadow-md);
      background: var(--card);
  }

  table {
    border-collapse: collapse;
    width: 100%;
    min-width: 800px;
      background-color: var(--card);
    color: var(--text);
      font-size: 0.875rem;
  }

  thead {
      background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-light) 100%);
  }

  th, td {
    text-align: left;
      padding: 1rem 1.25rem;
    vertical-align: top;
      border-bottom: 1px solid var(--border);
      line-height: 1.6;
  }

  th {
      font-weight: 700;
      color: var(--primary-dark);
    white-space: nowrap;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    tbody tr {
      transition: all 0.2s ease;
    }

    tbody tr:hover {
      background-color: var(--primary-bg);
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  .actions-cell {
    white-space: nowrap;
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
  }

  .chip-section-hdr {
    color: var(--muted);
    font-size: .7rem;
    font-weight: 500;
    letter-spacing: .02em;
    text-transform: uppercase;
  }

  .chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
  }

  .chip-btn {
      background-color: var(--primary-bg);
      border: 2px solid var(--primary);
      border-radius: var(--radius-md);
      padding: 0.625rem 1.125rem;
      font-size: 0.875rem;
      line-height: 1.4;
      font-weight: 600;
      color: var(--primary-dark);
    cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .chip-btn:hover {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #ffffff;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary-dark);
  }

  .chip-row-smallnote {
    font-size: .7rem;
    line-height: 1.4;
    color: var(--muted);
    margin-top: .25rem;
  }

  .med-guidance-list {
    list-style-type: disc;
    margin: .25rem 0 .5rem 1rem;
    padding: 0;
    display: flex;
    flex-direction: column;
    row-gap: .5rem;
    font-size: .7rem;
    color: var(--muted);
    line-height: 1.4;
  }
  .med-guidance-list li {
    margin: 0;
    padding: 0;
  }

  footer {
      font-size: 0.875rem;
      color: var(--text-muted);
    text-align: center;
      line-height: 1.8;
      padding: var(--spacing-2xl) var(--spacing-lg) var(--spacing-2xl);
      margin-top: var(--spacing-2xl);
      background: var(--card);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
  }

  footer a {
      color: var(--primary);
    text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    footer a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    .footer-brand {
      font-size: 1.1rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--spacing-sm);
    }

    .footer-credits {
      margin: var(--spacing-md) 0;
      color: var(--text-secondary);
    }

    .footer-license {
      margin-top: var(--spacing-md);
      font-size: 0.8rem;
      color: var(--text-muted);
  }
</style>
</head>

<body>
  <div class="app-container">
    <!-- Professional Brand Header -->
    <div class="brand-header">
      <div class="brand-logo">
        <img src="logo.png" alt="HomePAL Logo" class="brand-logo-img" />
      </div>
<header>
  <h1>Care Tracker</h1>
  <div class="subtitle">
          Comprehensive tracking for output, medications, oxygen, meals, vitals, sleep, and activity.
          All data is securely stored locally on this device.
  </div>
        <div class="section-right" style="margin-top: 1rem; flex-wrap: wrap;">
          <button class="main-btn" id="exportAllBtn" style="flex: 0 0 auto; min-width: auto; padding: 0.875rem 1.5rem; font-size: 0.95rem;">
      Export ALL Logs (Summary CSV)
    </button>
  </div>
</header>
    </div>

<!-- === Patient / Hospice Info Card === -->
<section class="card">
  <div class="section-title">
    <div class="section-left">
      <h2>
        Patient / Hospice Info
        <span class="pill">for triage calls</span>
      </h2>
      <div class="tiny-note">
        This stays local on this phone. Hospice will ask this when you call.
      </div>
    </div>
    <div class="section-right">
      <button class="sec-btn" id="saveProfileBtn">Save Profile</button>
    </div>
  </div>

  <div class="flex-row-wrap">
    <div class="field">
      <label for="profileName">Patient full name</label>
      <input id="profileName" placeholder="e.g. John A. Doe" />
    </div>

    <div class="field">
      <label for="profileDOB">DOB</label>
      <input id="profileDOB" placeholder="e.g. 01/23/1947" />
    </div>

    <div class="field">
      <label for="profileHospice">Hospice name</label>
      <input id="profileHospice" placeholder="e.g. Redwood Hospice" />
    </div>

    <div class="field field-can-drop">
      <label for="profilePhone">Hospice 24/7 number</label>
      <input id="profilePhone" placeholder="800-825-8556" />
    </div>
  </div>
</section>

<!-- === Emergency / Red Flag Card - Collapsible Pop-up === -->
<section class="alert-card collapsed" id="alertCard">
  <div class="alert-toggle" id="alertToggle">
    <span class="alert-toggle-text">ðŸš¨ Call hospice NOW if you see this:</span>
    <span class="alert-arrow">â–²</span>
  </div>
  <div class="alert-content">
  <ul class="alert-list">
    <li>No urine for many hours and belly looks bigger / tight / painful</li>
    <li>New bright red urine OR black / tarry stool</li>
    <li>Breathing looks like gasping / pulling at neck or ribs / RR very fast even at rest</li>
      <li>You cannot wake the patient or they're not responding like normal</li>
    <li>New seizure activity</li>
    <li>Sudden severe pain that morphine did not help</li>
      <li>Your gut says "the patient looks different and I'm scared"</li>
  </ul>
    <div class="tiny-note" style="color: var(--danger-text); margin-top: 1rem; font-weight: 500;">
      Call hospice 24/7: <span id="profilePhoneDisplay" style="font-weight: 700; color: var(--danger-text); font-size: 1rem;">800-825-8556</span>
    </div>
  </div>
</section>

<!-- === Output Log === -->
<section class="card">
  <div class="section-title">
    <div class="section-left">
      <h2>
        Output Log
        <span class="pill">Urine / Stool</span>
      </h2>
      <div class="tiny-note">
        Amount, color, straining, and if the patient needed help.
      </div>
    </div>
    <div class="section-right">
      <button class="sec-btn" id="exportOutputBtn">Export Output CSV</button>
    </div>
  </div>

  <div class="row-buttons">
    <button class="main-btn" id="urineBtn">Log Urine</button>
    <button class="main-btn" id="stoolBtn">Log Stool</button>
  </div>

  <div id="formCard" class="drawer-card">
    <div class="field">
      <label>Entry Type</label>
      <div id="entryTypeLabel" style="font-size:1rem;font-weight:600;color:#38bdf8;"></div>
    </div>

    <div class="flex-row-wrap">
      <div class="field">
        <label for="dateTimeInput">Date &amp; Time of Event
          <span class="tiny-note">(edit if logging late)</span></label>
        <input id="dateTimeInput" type="datetime-local" />
      </div>

      <div class="field field-can-drop">
        <label for="assistSelect">Assistance
          <span class="tiny-note">(unassisted / helped / catheter)</span></label>
        <select id="assistSelect">
          <option value="unassisted" selected>Unassisted / self</option>
          <option value="assisted">Assisted to commode / helped walking</option>
          <option value="catheter">Catheter / bag emptied</option>
        </select>
      </div>
    </div>

    <div class="flex-row-wrap">
      <div class="field">
        <label for="amountInput">Amount
          <span class="tiny-note">(mL OR "small/med/large")</span></label>
        <input id="amountInput" placeholder="e.g. 250 mL or medium or leaking" />
      </div>

      <div class="field field-can-drop">
        <label for="colorInput">Color / Appearance
          <span class="tiny-note">(amber, dark, tarry black, clay)</span></label>
        <input id="colorInput" placeholder="e.g. dark amber, tarry black" />
      </div>
    </div>

    <div class="flex-row-wrap">
      <div class="field">
        <label for="bloodSelect">Visible Blood?</label>
        <select id="bloodSelect">
          <option value="no" selected>No</option>
          <option value="yes-bright">Yes (bright red)</option>
          <option value="yes-dark">Yes (dark/brownish)</option>
        </select>
      </div>

      <div class="field field-can-drop">
        <label for="painSelect">Pain / Straining?
          <span class="tiny-note">(0 = none, 10 = worst)</span></label>
        <select id="painSelect">
          <option value="0" selected>0</option>
          <option>1</option><option>2</option><option>3</option><option>4</option>
          <option>5</option><option>6</option><option>7</option><option>8</option>
          <option>9</option><option>10</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label for="notesInput">Notes
        <span class="tiny-note">(odor, diarrhea, constipation, very sleepy)</span></label>
      <textarea id="notesInput" placeholder="e.g. strong smell, diarrhea, hard to start"></textarea>
    </div>

    <div class="save-row">
      <button class="main-btn" id="saveOutputBtn">Save Entry</button>
      <button class="sec-btn" id="cancelOutputBtn">Cancel</button>
    </div>
  </div>

  <div class="table-wrapper" style="margin-top:1rem;">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Assist</th>
          <th>Amount</th>
          <th>Color</th>
          <th>Blood?</th>
          <th>Pain</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="logTableBody"></tbody>
    </table>
  </div>
</section>

<!-- === Medications === -->
<section class="card">
  <div class="section-title">
    <div class="section-left">
      <h2>
        Medication Given
        <span class="pill">Scheduled / PRN</span>
      </h2>
      <div class="tiny-note">
        Tap a med below, fill dose, save. Includes comfort meds (palliative).
      </div>
    </div>
    <div class="section-right">
      <button class="main-btn" id="openMedBtn" style="min-width:auto;flex:0 0 auto;padding:.8rem 1rem;font-size:.9rem;">Log Medication</button>
      <button class="sec-btn" id="exportMedBtn">Export Meds CSV</button>
    </div>
  </div>

  <div id="medCard" class="drawer-card">
    <div class="block-group">
      <div class="chip-section-hdr">Scheduled / Daily</div>
      <div class="chip-row" id="scheduledChips"></div>
      <div class="chip-row-smallnote">
        Hydrocortisone 5 mg tab: 1 tab AM + 1 tab at 2â€“3 PM (avoid insomnia).<br/>
        Omeprazole 20 mg cap: 1 cap in AM (stomach protection).
      </div>
    </div>

    <div class="block-group">
      <div class="chip-section-hdr">Comfort / PRN</div>
      <div class="chip-row" id="prnChips"></div>
      <ul class="med-guidance-list">
        <li>Acetaminophen 650 mg suppository: rectal q6h PRN pain/fever (max 4 doses / 24h)</li>
        <li>Bisacodyl 10 mg suppository: rectal daily PRN constipation (max 1 / 24h)</li>
        <li>Hyoscyamine 0.125 mg ODT: PO/SL q4h PRN secretions (max 6 / 24h)</li>
        <li>Lorazepam liquid 1 mg: q4h PRN anxiety/agitation (max 6 / 24h)</li>
        <li>Morphine oral 0.5 mg (0.25 mL): q4h PRN pain / SOB (max 6 / 24h)</li>
        <li>Senna 8.6 mg: take 2 tabs PO daily PRN constipation (max 12 tabs / 24h)</li>
        <li>Phenobarbital 60 mg tab: q8h ATC if severe agitation or seizure not controlled</li>
      </ul>
    </div>

    <div class="flex-row-wrap" style="align-items:center;">
      <div class="tiny-note" style="flex:1 1 auto;">
        Can't find it? Add to quick list:
      </div>
      <button class="sec-btn" id="addMedNameBtn" style="flex:0 0 auto;min-width:auto;">+ Add med</button>
    </div>

    <div class="block-group">
      <div class="flex-row-wrap">
        <div class="field">
          <label for="medDateTimeInput">Date &amp; Time Given</label>
          <input id="medDateTimeInput" type="datetime-local" />
        </div>

        <div class="field">
          <label for="medChosenName">Medication Name
            <span class="tiny-note">(auto-fills when you tap a chip)</span></label>
          <input id="medChosenName" placeholder="tap chip or type manually" />
        </div>

        <div class="field field-can-drop">
          <label for="medCategory">Category
            <span class="tiny-note">(scheduled / prn)</span></label>
          <input id="medCategory" placeholder="scheduled / prn" />
        </div>
      </div>

      <div class="flex-row-wrap">
        <div class="field">
          <label for="medDoseInput">Dose / Route
            <span class="tiny-note">(e.g. 0.25 mL morphine PO)</span></label>
          <input id="medDoseInput" placeholder="e.g. 650 mg suppository rectal" />
        </div>

        <div class="field field-can-drop">
          <label for="medReasonInput">Reason
            <span class="tiny-note">(pain 8/10, anxiety, noisy breathing)</span></label>
          <input id="medReasonInput" placeholder="pain 8/10 / SOB at rest / agitation" />
        </div>
      </div>

      <div class="field">
        <label for="medNotesInput">Notes / Effect
          <span class="tiny-note">(calmer? easier breathing?)</span></label>
        <textarea id="medNotesInput" placeholder="calmer within 20 min, RR slower"></textarea>
      </div>
    </div>

    <div class="save-row">
      <button class="main-btn" id="medSaveBtn">Save Med Entry</button>
      <button class="sec-btn" id="medCancelBtn">Cancel</button>
    </div>
  </div>

  <div class="table-wrapper" style="margin-top:1rem;">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Medication</th>
          <th>Category</th>
          <th>Dose / Route</th>
          <th>Reason</th>
          <th>Notes / Effect</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="medTableBody"></tbody>
    </table>
  </div>
</section>

<!-- === Oxygen / Breathing === -->
<section class="card">
  <div class="section-title">
    <div class="section-left">
      <h2>
        Oxygen / Breathing
        <span class="pill">Comfort Support</span>
      </h2>
      <div class="tiny-note">
        Nasal cannula / mask, flow rate, did it calm the breathing.
      </div>
    </div>
    <div class="section-right">
      <button class="main-btn" id="openOxyBtn" style="min-width:auto;flex:0 0 auto;padding:.8rem 1rem;font-size:.9rem;">Log Oxygen</button>
      <button class="sec-btn" id="exportOxyBtn">Export Oâ‚‚ CSV</button>
    </div>
  </div>

  <div id="oxyCard" class="drawer-card">
    <div class="block-group">
      <div class="flex-row-wrap">
        <div class="field">
          <label for="oxyDateTimeInput">Date &amp; Time Started</label>
          <input id="oxyDateTimeInput" type="datetime-local" />
        </div>

        <div class="field">
          <label for="oxyFlowInput">Flow Rate (L/min)</label>
          <input id="oxyFlowInput" placeholder="e.g. 2 L/min" />
        </div>

        <div class="field field-can-drop">
          <label for="oxyMethodSelect">Delivery
            <span class="tiny-note">(nasal cannula / mask)</span></label>
          <select id="oxyMethodSelect">
            <option value="Nasal cannula">Nasal cannula</option>
            <option value="Mask">Mask</option>
          </select>
        </div>
      </div>

      <div class="flex-row-wrap">
        <div class="field">
          <label for="oxyDurationInput">Duration (minutes)</label>
          <input id="oxyDurationInput" placeholder="e.g. 20 min" />
        </div>

        <div class="field field-can-drop">
          <label for="oxyReasonInput">Reason
            <span class="tiny-note">(SOB, anxiety, comfort)</span></label>
          <input id="oxyReasonInput" placeholder="short of breath at rest" />
        </div>
      </div>

      <div class="field">
        <label for="oxyReliefInput">Did it help?
          <span class="tiny-note">(calmer, RR lower, still gasping)</span></label>
        <textarea id="oxyReliefInput" placeholder="calmer, RR improved, still distressed"></textarea>
      </div>
    </div>

    <div class="save-row">
      <button class="main-btn" id="oxySaveBtn">Save Oxygen Entry</button>
      <button class="sec-btn" id="oxyCancelBtn">Cancel</button>
    </div>
  </div>

  <div class="table-wrapper" style="margin-top:1rem;">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Flow / Method</th>
          <th>Duration</th>
          <th>Reason</th>
          <th>Relief / Effect</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="oxyTableBody"></tbody>
    </table>
  </div>
</section>

<!-- === Meals / Intake === -->
<section class="card">
  <div class="section-title">
    <div class="section-left">
      <h2>
        Meals / Intake
        <span class="pill">Nutrition</span>
      </h2>
      <div class="tiny-note">
        How much the patient actually took in, and nausea/vomiting.
      </div>
    </div>
    <div class="section-right">
      <button class="main-btn" id="openMealBtn" style="min-width:auto;flex:0 0 auto;padding:.8rem 1rem;font-size:.9rem;">Log Meal</button>
      <button class="sec-btn" id="exportMealBtn">Export Meals CSV</button>
    </div>
  </div>

  <div id="mealCard" class="drawer-card">
    <div class="block-group">
      <div class="flex-row-wrap">
        <div class="field">
          <label for="mealDateTimeInput">Date &amp; Time</label>
          <input id="mealDateTimeInput" type="datetime-local" />
        </div>

        <div class="field">
          <label for="mealTypeSelect">Meal Type</label>
          <select id="mealTypeSelect">
            <option>Breakfast</option>
            <option>Lunch</option>
            <option>Dinner</option>
            <option>Snack / sip / supplement</option>
          </select>
        </div>

        <div class="field field-can-drop">
          <label for="mealTextureSelect">Consistency</label>
          <select id="mealTextureSelect">
            <option>Regular</option>
            <option>Soft</option>
            <option>Pureed</option>
            <option>Liquid only / sips</option>
            <option>None</option>
          </select>
        </div>
      </div>

      <div class="flex-row-wrap">
        <div class="field">
          <label for="mealPercentSelect">Portion eaten
            <span class="tiny-note">(% of what was offered)</span></label>
          <select id="mealPercentSelect">
            <option>0%</option>
            <option>25%</option>
            <option>50%</option>
            <option>75%</option>
            <option>100%</option>
          </select>
        </div>

        <div class="field field-can-drop">
          <label for="mealNauseaSelect">Nausea / Vomit?</label>
          <select id="mealNauseaSelect">
            <option>No</option>
            <option>Nausea only</option>
            <option>Vomited</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="mealNotesInput">Notes
          <span class="tiny-note">(refused food, coughing while eating, very sleepy)</span></label>
        <textarea id="mealNotesInput" placeholder="only sips water, said no appetite"></textarea>
      </div>
    </div>

    <div class="save-row">
      <button class="main-btn" id="mealSaveBtn">Save Meal Entry</button>
      <button class="sec-btn" id="mealCancelBtn">Cancel</button>
    </div>
  </div>

  <div class="table-wrapper" style="margin-top:1rem;">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Meal</th>
          <th>Texture</th>
          <th>Portion</th>
          <th>Nausea/Vomit</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="mealTableBody"></tbody>
    </table>
  </div>
</section>

<!-- === Vitals === -->
<section class="card">
  <div class="section-title">
    <div class="section-left">
      <h2>
        Vitals
        <span class="pill">BP / Pulse / RR / Oâ‚‚%</span>
      </h2>
      <div class="tiny-note">
        Include position + timing (before meal / after meal).
      </div>
    </div>
    <div class="section-right">
      <button class="main-btn" id="openVitalBtn" style="min-width:auto;flex:0 0 auto;padding:.8rem 1rem;font-size:.9rem;">Log Vitals</button>
      <button class="sec-btn" id="exportVitalBtn">Export Vitals CSV</button>
    </div>
  </div>

  <div id="vitalsCard" class="drawer-card">
    <div class="block-group">
      <div class="flex-row-wrap">
        <div class="field">
          <label for="vitalDateTimeInput">Date &amp; Time</label>
          <input id="vitalDateTimeInput" type="datetime-local" />
        </div>

        <div class="field">
          <label for="vitalSysInput">Systolic (top #)</label>
          <input id="vitalSysInput" placeholder="e.g. 112" />
        </div>

        <div class="field field-can-drop">
          <label for="vitalDiaInput">Diastolic (bottom #)</label>
          <input id="vitalDiaInput" placeholder="e.g. 68" />
        </div>

        <div class="field field-can-drop">
          <label for="vitalPulseInput">Pulse (HR)</label>
          <input id="vitalPulseInput" placeholder="e.g. 84" />
        </div>
      </div>

      <div class="flex-row-wrap">
        <div class="field">
          <label for="vitalRRInput">Resp Rate (breaths/min)</label>
          <input id="vitalRRInput" placeholder="e.g. 20" />
        </div>

        <div class="field field-can-drop">
          <label for="vitalSpO2Input">Pulse Oâ‚‚ %</label>
          <input id="vitalSpO2Input" placeholder="e.g. 95%" />
        </div>

        <div class="field field-can-drop">
          <label for="vitalPosSelect">Position</label>
          <select id="vitalPosSelect">
            <option>Sitting</option>
            <option>Lying</option>
            <option>Standing</option>
          </select>
        </div>

        <div class="field field-can-drop">
          <label for="vitalFastingSelect">Timing
            <span class="tiny-note">(fasting vs after meal)</span></label>
          <select id="vitalFastingSelect">
            <option>Fasting / before meal</option>
            <option>After meal</option>
            <option>Unknown</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="vitalNotesInput">Notes
          <span class="tiny-note">(dizzy, weak, slept all day)</span></label>
        <textarea id="vitalNotesInput" placeholder="very sleepy, hard to wake, dizzy standing"></textarea>
      </div>
    </div>

    <div class="save-row">
      <button class="main-btn" id="vitalSaveBtn">Save Vitals Entry</button>
      <button class="sec-btn" id="vitalCancelBtn">Cancel</button>
    </div>
  </div>

  <div class="table-wrapper" style="margin-top:1rem;">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>BP (sys/dia)</th>
          <th>Pulse</th>
          <th>RR</th>
          <th>SpOâ‚‚%</th>
          <th>Position</th>
          <th>Timing</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="vitalTableBody"></tbody>
    </table>
  </div>
</section>

<!-- === Sleep / Rest === -->
<section class="card">
  <div class="section-title">
    <div class="section-left">
      <h2>
        Sleep / Rest
        <span class="pill">Overnight / Naps</span>
      </h2>
      <div class="tiny-note">
        Start/end, total hours, how restful the patient seemed.
      </div>
    </div>
    <div class="section-right">
      <button class="main-btn" id="openSleepBtn" style="min-width:auto;flex:0 0 auto;padding:.8rem 1rem;font-size:.9rem;">Log Sleep</button>
      <button class="sec-btn" id="exportSleepBtn">Export Sleep CSV</button>
    </div>
  </div>

  <div id="sleepCard" class="drawer-card">
    <div class="block-group">

      <div class="flex-row-wrap">
        <div class="field">
          <label for="sleepStartInput">Start Time</label>
          <input id="sleepStartInput" type="datetime-local" />
        </div>

        <div class="field">
          <label for="sleepEndInput">End Time</label>
          <input id="sleepEndInput" type="datetime-local" />
        </div>

        <div class="field field-can-drop">
          <label for="sleepTotalInput">Total Sleep (hrs)
            <span class="tiny-note">(or best guess)</span></label>
          <input id="sleepTotalInput" placeholder="e.g. 4.5" />
        </div>
      </div>

      <div class="flex-row-wrap">
        <div class="field">
          <label for="sleepQualitySelect">Quality</label>
          <select id="sleepQualitySelect">
            <option>Good / mostly calm</option>
            <option>Okay / some restlessness</option>
            <option>Poor / very restless</option>
          </select>
        </div>

        <div class="field field-can-drop">
          <label for="sleepAssistSelect">Needed repositioning / meds?</label>
          <select id="sleepAssistSelect">
            <option>No help needed</option>
            <option>Repositioned in bed</option>
            <option>Comfort med given for sleep</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="sleepNotesInput">Notes
          <span class="tiny-note">(woke gasping, moaning, pain, talking in sleep)</span></label>
        <textarea id="sleepNotesInput" placeholder="restless ~2am, said back pain, calmed after morphine"></textarea>
      </div>

    </div>

    <div class="save-row">
      <button class="main-btn" id="sleepSaveBtn">Save Sleep Entry</button>
      <button class="sec-btn" id="sleepCancelBtn">Cancel</button>
    </div>
  </div>

  <div class="table-wrapper" style="margin-top:1rem;">
    <table>
      <thead>
        <tr>
          <th>Start</th>
          <th>End</th>
          <th>Total hrs</th>
          <th>Quality</th>
          <th>Assist / Meds</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="sleepTableBody"></tbody>
    </table>
  </div>
</section>

<!-- === Activity / Mobility === -->
<section class="card">
  <div class="section-title">
    <div class="section-left">
      <h2>
        Activity / Mobility
        <span class="pill">Movement</span>
      </h2>
      <div class="tiny-note">
        Sat up, walked to bathroom, talked w/ family, etc.
      </div>
    </div>
    <div class="section-right">
      <button class="main-btn" id="openActBtn" style="min-width:auto;flex:0 0 auto;padding:.8rem 1rem;font-size:.9rem;">Log Activity</button>
      <button class="sec-btn" id="exportActBtn">Export Activity CSV</button>
    </div>
  </div>

  <div id="actCard" class="drawer-card">
    <div class="block-group">

      <div class="flex-row-wrap">
        <div class="field">
          <label for="actDateTimeInput">Date &amp; Time</label>
          <input id="actDateTimeInput" type="datetime-local" />
        </div>

        <div class="field">
          <label for="actTypeInput">Activity
            <span class="tiny-note">(sat in recliner, walked to restroom, talked w/family)</span></label>
          <input id="actTypeInput" placeholder="sat on edge of bed, feet down" />
        </div>

        <div class="field field-can-drop">
          <label for="actAssistSelect">Assistance</label>
          <select id="actAssistSelect">
            <option>Independent</option>
            <option>Stand-by assist</option>
            <option>Hands-on assist</option>
            <option>Could not attempt</option>
          </select>
        </div>
      </div>

      <div class="flex-row-wrap">
        <div class="field">
          <label for="actDurationInput">Duration (min)</label>
          <input id="actDurationInput" placeholder="e.g. 5" />
        </div>

        <div class="field field-can-drop">
          <label for="actToleranceSelect">Tolerance
            <span class="tiny-note">(okay / tired / SOB / dizzy)</span></label>
          <select id="actToleranceSelect">
            <option>Okay</option>
            <option>Very tired</option>
            <option>Short of breath</option>
            <option>Dizzy / weak</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="actNotesInput">Notes
          <span class="tiny-note">(needed rest right after, chest pain, etc.)</span></label>
        <textarea id="actNotesInput" placeholder="needed 2-person assist to stand, very weak today"></textarea>
      </div>

    </div>

    <div class="save-row">
      <button class="main-btn" id="actSaveBtn">Save Activity Entry</button>
      <button class="sec-btn" id="actCancelBtn">Cancel</button>
    </div>
  </div>

  <div class="table-wrapper" style="margin-top:1rem;">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Activity</th>
          <th>Assist</th>
          <th>Duration</th>
          <th>Tolerance</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="actTableBody"></tbody>
    </table>
  </div>
</section>

<footer>
      <div class="footer-brand">HomePAL</div>
      <div class="footer-credits">
        Â© 2025 by <a href="https://sites.google.com/view/sabourshaik/home?authuser=0">Abdus Sabour Shaik</a> and <a href="https://www.linkedin.com/in/joshua-robert/">Joshua Robert</a>
      </div>
      <div class="footer-license">
        Licensed under <a href="https://creativecommons.org/licenses/by-nd/4.0/">CC BY-ND 4.0</a>
        <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" alt="CC" style="max-width: 1em; max-height: 1em; margin-left: 0.3em; vertical-align: middle;">
        <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" alt="BY" style="max-width: 1em; max-height: 1em; margin-left: 0.2em; vertical-align: middle;">
        <img src="https://mirrors.creativecommons.org/presskit/icons/nd.svg" alt="ND" style="max-width: 1em; max-height: 1em; margin-left: 0.2em; vertical-align: middle;">
      </div>
      <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); color: var(--text-secondary);">
        <div style="margin-bottom: 0.5rem;">Built with care for families and care teams.</div>
        <div style="margin-bottom: 0.5rem; font-weight: 600; color: var(--primary-dark);">
          <span id="footerHospiceName">Redwood Hospice</span> 24/7 Line: <a id="footerHospicePhone" href="tel:8008258556" style="color: var(--primary);">800-825-8556</a>
        </div>
        <div style="font-size: 0.8rem; color: var(--text-muted);">
          All entries stay securely on this device. This does not replace medical advice. Call hospice for urgent concerns.
        </div>
      </div>
</footer>
  </div> <!-- End app-container -->

<script>
    /* ========= MODULAR ARCHITECTURE: Data Service with Error Handling ========= */
    const DataService = {
      loadArr(key) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error(`Error loading ${key}:`, e);
          this.showError(`Failed to load ${key}. Data may be corrupted.`);
          return [];
        }
      },

      saveArr(key, arr) {
        try {
          const serialized = JSON.stringify(arr);
          const sizeMB = (serialized.length / (1024 * 1024)).toFixed(2);
          
          // Check storage quota (localStorage typically 5-10MB)
          if (serialized.length > 4.5 * 1024 * 1024) {
            throw new Error("QUOTA_EXCEEDED");
          }
          
          localStorage.setItem(key, serialized);
          
          // Warn if approaching limit
          if (serialized.length > 3 * 1024 * 1024) {
            this.showWarning(`Storage is getting full (${sizeMB}MB). Consider exporting old data.`);
          }
          
          return { success: true };
        } catch (e) {
          if (e.message === "QUOTA_EXCEEDED" || e.name === "QuotaExceededError") {
            this.showError("Storage full! Please export your data and clear old entries.");
            return { success: false, error: "QUOTA_EXCEEDED" };
          }
          console.error(`Error saving ${key}:`, e);
          this.showError(`Failed to save ${key}. Please try again.`);
          return { success: false, error: e.message };
        }
      },

      loadField(key, fallback = "") {
        try {
  return localStorage.getItem(key) || fallback;
        } catch (e) {
          console.error(`Error loading field ${key}:`, e);
          return fallback;
        }
      },

      saveField(key, val) {
        try {
          const value = val || "";
          if (value.length > 100000) {
            throw new Error("Value too large");
          }
          localStorage.setItem(key, value);
          return { success: true };
        } catch (e) {
          if (e.name === "QuotaExceededError") {
            this.showError("Storage full! Please export your data.");
            return { success: false, error: "QUOTA_EXCEEDED" };
          }
          console.error(`Error saving field ${key}:`, e);
          return { success: false, error: e.message };
        }
      },

      showError(message) {
        // Create or update error notification
        let errorDiv = document.getElementById("error-notification");
        if (!errorDiv) {
          errorDiv = document.createElement("div");
          errorDiv.id = "error-notification";
          errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger-bg);
            border: 2px solid var(--danger-border);
            color: var(--danger-text);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            max-width: 500px;
            font-weight: 600;
          `;
          document.body.appendChild(errorDiv);
        }
        errorDiv.textContent = message;
        setTimeout(() => errorDiv.remove(), 5000);
      },

      showWarning(message) {
        let warningDiv = document.getElementById("warning-notification");
        if (!warningDiv) {
          warningDiv = document.createElement("div");
          warningDiv.id = "warning-notification";
          warningDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning-bg);
            border: 2px solid var(--warning);
            color: var(--warning-text);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            max-width: 500px;
            font-weight: 600;
          `;
          document.body.appendChild(warningDiv);
        }
        warningDiv.textContent = message;
        setTimeout(() => warningDiv.remove(), 4000);
      },

      showSuccess(message) {
        let successDiv = document.getElementById("success-notification");
        if (!successDiv) {
          successDiv = document.createElement("div");
          successDiv.id = "success-notification";
          successDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-bg);
            border: 2px solid var(--success);
            color: var(--success-text);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            max-width: 500px;
            font-weight: 600;
          `;
          document.body.appendChild(successDiv);
        }
        successDiv.textContent = message;
        setTimeout(() => successDiv.remove(), 3000);
      }
    };

    /* ========= MODULAR ARCHITECTURE: Validation Service ========= */
    const ValidationService = {
      // Sanitize text to prevent XSS
      sanitize(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = String(text);
        return div.innerHTML;
      },

      // Validate vitals and return warnings
      validateVitals(sys, dia, pulse, rr, spO2) {
        const warnings = [];
        const errors = [];

        // Parse numeric values
        const sysNum = sys ? parseFloat(sys) : null;
        const diaNum = dia ? parseFloat(dia) : null;
        const pulseNum = pulse ? parseFloat(pulse) : null;
        const rrNum = rr ? parseFloat(rr) : null;
        const spO2Num = spO2 ? parseFloat(spO2.toString().replace('%', '')) : null;

        // Critical alerts (red flags)
        if (spO2Num !== null) {
          if (spO2Num < 85) {
            errors.push("ðŸš¨ CRITICAL: SpO2 < 85% - Call hospice immediately!");
          } else if (spO2Num < 90) {
            warnings.push("âš ï¸ Low SpO2 (< 90%) - Consider calling hospice");
          }
        }

        if (rrNum !== null) {
          if (rrNum > 35) {
            errors.push("ðŸš¨ CRITICAL: Respiratory rate > 35 - Call hospice immediately!");
          } else if (rrNum > 30) {
            warnings.push("âš ï¸ High respiratory rate (> 30) - Monitor closely");
          } else if (rrNum < 8) {
            errors.push("ðŸš¨ CRITICAL: Respiratory rate < 8 - Call hospice immediately!");
          }
        }

        if (sysNum !== null) {
          if (sysNum > 200 || sysNum < 70) {
            warnings.push("âš ï¸ BP outside normal range - Document and monitor");
          }
        }

        if (diaNum !== null) {
          if (diaNum > 120 || diaNum < 40) {
            warnings.push("âš ï¸ Diastolic BP outside normal range - Document and monitor");
          }
        }

        if (pulseNum !== null) {
          if (pulseNum > 150) {
            warnings.push("âš ï¸ High pulse rate (> 150) - Monitor closely");
          } else if (pulseNum < 40) {
            warnings.push("âš ï¸ Low pulse rate (< 40) - Monitor closely");
          }
        }

        return { warnings, errors, isValid: errors.length === 0 };
      },

      // Check medication dosing limits
      checkMedicationLimit(medName, medTime, allMedEntries, timeWindowHours = 24) {
        const medLimits = {
          "Morphine oral 0.5 mg (0.25 mL)": { max: 6, window: 24 },
          "Lorazepam liquid 1 mg": { max: 6, window: 24 },
          "Hyoscyamine 0.125 mg ODT": { max: 6, window: 24 },
          "Acetaminophen 650 mg suppository": { max: 4, window: 24 },
          "Bisacodyl 10 mg suppository": { max: 1, window: 24 },
          "Senna 8.6 mg tabs (2 tabs)": { max: 12, window: 24 },
          "Phenobarbital 60 mg tab": { max: 3, window: 24 }
        };

        const limit = medLimits[medName];
        if (!limit) return { withinLimit: true, count: 0, max: null };

        const windowStart = new Date(new Date(medTime).getTime() - limit.window * 60 * 60 * 1000);
        const recentDoses = allMedEntries.filter(e => {
          if (e.name !== medName) return false;
          const doseTime = new Date(e.time);
          return doseTime >= windowStart && doseTime <= new Date(medTime);
        });

        const count = recentDoses.length;
        const withinLimit = count < limit.max;

        return {
          withinLimit,
          count,
          max: limit.max,
          window: limit.window,
          warning: !withinLimit ? `âš ï¸ Maximum ${limit.max} doses per ${limit.window} hours reached!` : null
        };
      },

      // Validate medication entry
      validateMedication(name, dose, time, allMedEntries) {
        const errors = [];
        const warnings = [];

        if (!name || name.trim() === "") {
          errors.push("Medication name is required");
        }

        if (!dose || dose.trim() === "") {
          errors.push("Dose/route is required");
        }

        if (!time) {
          errors.push("Time is required");
        }

        // Check for future dates
        if (time && new Date(time) > new Date()) {
          warnings.push("âš ï¸ Future date detected - please verify time is correct");
        }

        // Check medication limits
        if (name) {
          const limitCheck = this.checkMedicationLimit(name, time, allMedEntries);
          if (!limitCheck.withinLimit) {
            errors.push(limitCheck.warning);
          } else if (limitCheck.count >= limitCheck.max - 1) {
            warnings.push(`âš ï¸ Approaching limit: ${limitCheck.count}/${limitCheck.max} doses in last ${limitCheck.window}h`);
          }
        }

        return { errors, warnings, isValid: errors.length === 0 };
      },

      // Validate datetime
      validateDateTime(dateTimeStr, allowFuture = false) {
        if (!dateTimeStr) return { isValid: false, error: "Date/time is required" };
        
        const date = new Date(dateTimeStr);
        if (isNaN(date.getTime())) {
          return { isValid: false, error: "Invalid date/time format" };
        }

        if (!allowFuture && date > new Date()) {
          return { isValid: false, error: "Future dates are not allowed" };
        }

        return { isValid: true };
      }
    };

/* ========= ID helper ========= */
function newId() {
  return Date.now().toString() + "_" + Math.random().toString(16).slice(2);
}

/* ========= Timestamp Helpers ========= */
    function nowLocalDatetimeValue() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth() + 1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function niceNowStamp() {
      const d = new Date();
      const pad = n => String(n).padStart(2, "0");
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth() + 1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function fileStamp() {
      const d = new Date();
      const pad = n => String(n).padStart(2, "0");
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth() + 1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}_${hh}-${mi}`;
    }

    /* ========= Global arrays ========= */
    let outputEntries = DataService.loadArr("outputEntries");   // urine/stool
    let medEntries = DataService.loadArr("medEntries");         // meds
    let oxyEntries = DataService.loadArr("oxyEntries");         // oxygen
    let mealEntries = DataService.loadArr("mealEntries");        // meals
    let vitalEntries = DataService.loadArr("vitalEntries");      // vitals
    let sleepEntries = DataService.loadArr("sleepEntries");      // sleep
    let actEntries = DataService.loadArr("actEntries");          // activity

    /* ========= Profile load ========= */
    const profileNameEl = document.getElementById("profileName");
    const profileDOBEl = document.getElementById("profileDOB");
    const profileHospiceEl = document.getElementById("profileHospice");
    const profilePhoneEl = document.getElementById("profilePhone");
    const profilePhoneDisplay = document.getElementById("profilePhoneDisplay");
    const footerHospiceName = document.getElementById("footerHospiceName");
    const footerHospicePhone = document.getElementById("footerHospicePhone");

    // Function to update all hospice references throughout the page
    function updateHospiceReferences() {
      const hospiceName = profileHospiceEl.value || "Redwood Hospice";
      const hospicePhone = profilePhoneEl.value || "800-825-8556";
      const hospicePhoneClean = hospicePhone.replace(/\D/g, ""); // Remove non-digits for tel: link

      // Update alert card phone display
      if (profilePhoneDisplay) {
        profilePhoneDisplay.textContent = hospicePhone;
      }

      // Update footer hospice name and phone
      if (footerHospiceName) {
        footerHospiceName.textContent = hospiceName;
      }
      if (footerHospicePhone) {
        footerHospicePhone.textContent = hospicePhone;
        footerHospicePhone.href = `tel:${hospicePhoneClean}`;
      }
    }

    // Load profile values
    profileNameEl.value = DataService.loadField("profileName", "");
    profileDOBEl.value = DataService.loadField("profileDOB", "");
    profileHospiceEl.value = DataService.loadField("profileHospice", "Redwood Hospice");
    profilePhoneEl.value = DataService.loadField("profilePhone", "800-825-8556");

    // Update all references on page load
    updateHospiceReferences();

    /* ========= Profile Save ========= */
    // Saves patient profile info (name, DOB, hospice name, phone) to browser localStorage
    // This data persists on this device and is used to:
    // 1. Pre-fill the form when you return
    // 2. Display the hospice name and phone number throughout the app (alert card, footer)
    // All data stays local - never sent to any server
    document.getElementById("saveProfileBtn").addEventListener("click", () => {
      const results = [
        DataService.saveField("profileName", profileNameEl.value),
        DataService.saveField("profileDOB", profileDOBEl.value),
        DataService.saveField("profileHospice", profileHospiceEl.value),
        DataService.saveField("profilePhone", profilePhoneEl.value)
      ];
      
      if (results.every(r => r.success)) {
        updateHospiceReferences();
        DataService.showSuccess("Profile saved on this device.");
      }
    });

    // Also update when user types in the fields (optional - for real-time updates)
    profileHospiceEl.addEventListener("input", updateHospiceReferences);
    profilePhoneEl.addEventListener("input", updateHospiceReferences);

    /* ========= Alert Card Toggle ========= */
    const alertCard = document.getElementById("alertCard");
    const alertToggle = document.getElementById("alertToggle");

    if (alertToggle) {
      alertToggle.addEventListener("click", () => {
        alertCard.classList.toggle("collapsed");
      });
    }

/* ========= DOM refs for Output ========= */
const urineBtn       = document.getElementById("urineBtn");
const stoolBtn       = document.getElementById("stoolBtn");
const formCard       = document.getElementById("formCard");
const entryTypeLabel = document.getElementById("entryTypeLabel");
const dateTimeInput  = document.getElementById("dateTimeInput");
const assistSelect   = document.getElementById("assistSelect");
const amountInput    = document.getElementById("amountInput");
const colorInput     = document.getElementById("colorInput");
const bloodSelect    = document.getElementById("bloodSelect");
const painSelect     = document.getElementById("painSelect");
const notesInput     = document.getElementById("notesInput");
const saveOutputBtn  = document.getElementById("saveOutputBtn");
const cancelOutputBtn= document.getElementById("cancelOutputBtn");
const logTableBody   = document.getElementById("logTableBody");
const exportOutputBtn= document.getElementById("exportOutputBtn");

/* ========= DOM refs for Meds ========= */
const openMedBtn        = document.getElementById("openMedBtn");
const medCard           = document.getElementById("medCard");
const scheduledChipsDiv = document.getElementById("scheduledChips");
const prnChipsDiv       = document.getElementById("prnChips");
const addMedNameBtn     = document.getElementById("addMedNameBtn");
const medDateTimeInput  = document.getElementById("medDateTimeInput");
const medChosenName     = document.getElementById("medChosenName");
const medCategory       = document.getElementById("medCategory");
const medDoseInput      = document.getElementById("medDoseInput");
const medReasonInput    = document.getElementById("medReasonInput");
const medNotesInput     = document.getElementById("medNotesInput");
const medSaveBtn        = document.getElementById("medSaveBtn");
const medCancelBtn      = document.getElementById("medCancelBtn");
const medTableBody      = document.getElementById("medTableBody");
const exportMedBtn      = document.getElementById("exportMedBtn");

/* ========= DOM refs for Oxygen ========= */
const openOxyBtn        = document.getElementById("openOxyBtn");
const oxyCard           = document.getElementById("oxyCard");
const oxyDateTimeInput  = document.getElementById("oxyDateTimeInput");
const oxyFlowInput      = document.getElementById("oxyFlowInput");
const oxyMethodSelect   = document.getElementById("oxyMethodSelect");
const oxyDurationInput  = document.getElementById("oxyDurationInput");
const oxyReasonInput    = document.getElementById("oxyReasonInput");
const oxyReliefInput    = document.getElementById("oxyReliefInput");
const oxySaveBtn        = document.getElementById("oxySaveBtn");
const oxyCancelBtn      = document.getElementById("oxyCancelBtn");
const oxyTableBody      = document.getElementById("oxyTableBody");
const exportOxyBtn      = document.getElementById("exportOxyBtn");

/* ========= DOM refs for Meals ========= */
const openMealBtn       = document.getElementById("openMealBtn");
const mealCard          = document.getElementById("mealCard");
const mealDateTimeInput = document.getElementById("mealDateTimeInput");
const mealTypeSelect    = document.getElementById("mealTypeSelect");
const mealTextureSelect = document.getElementById("mealTextureSelect");
const mealPercentSelect = document.getElementById("mealPercentSelect");
const mealNauseaSelect  = document.getElementById("mealNauseaSelect");
const mealNotesInput    = document.getElementById("mealNotesInput");
const mealSaveBtn       = document.getElementById("mealSaveBtn");
const mealCancelBtn     = document.getElementById("mealCancelBtn");
const mealTableBody     = document.getElementById("mealTableBody");
const exportMealBtn     = document.getElementById("exportMealBtn");

/* ========= DOM refs for Vitals ========= */
const openVitalBtn      = document.getElementById("openVitalBtn");
const vitalsCard        = document.getElementById("vitalsCard");
const vitalDateTimeInput= document.getElementById("vitalDateTimeInput");
const vitalSysInput     = document.getElementById("vitalSysInput");
const vitalDiaInput     = document.getElementById("vitalDiaInput");
const vitalPulseInput   = document.getElementById("vitalPulseInput");
const vitalRRInput      = document.getElementById("vitalRRInput");
const vitalSpO2Input    = document.getElementById("vitalSpO2Input");
const vitalPosSelect    = document.getElementById("vitalPosSelect");
const vitalFastingSelect= document.getElementById("vitalFastingSelect");
const vitalNotesInput   = document.getElementById("vitalNotesInput");
const vitalSaveBtn      = document.getElementById("vitalSaveBtn");
const vitalCancelBtn    = document.getElementById("vitalCancelBtn");
const vitalTableBody    = document.getElementById("vitalTableBody");
const exportVitalBtn    = document.getElementById("exportVitalBtn");

/* ========= DOM refs for Sleep ========= */
const openSleepBtn      = document.getElementById("openSleepBtn");
const sleepCard         = document.getElementById("sleepCard");
const sleepStartInput   = document.getElementById("sleepStartInput");
const sleepEndInput     = document.getElementById("sleepEndInput");
const sleepTotalInput   = document.getElementById("sleepTotalInput");
const sleepQualitySelect= document.getElementById("sleepQualitySelect");
const sleepAssistSelect = document.getElementById("sleepAssistSelect");
const sleepNotesInput   = document.getElementById("sleepNotesInput");
const sleepSaveBtn      = document.getElementById("sleepSaveBtn");
const sleepCancelBtn    = document.getElementById("sleepCancelBtn");
const sleepTableBody    = document.getElementById("sleepTableBody");
const exportSleepBtn    = document.getElementById("exportSleepBtn");

/* ========= DOM refs for Activity ========= */
const openActBtn        = document.getElementById("openActBtn");
const actCard           = document.getElementById("actCard");
const actDateTimeInput  = document.getElementById("actDateTimeInput");
const actTypeInput      = document.getElementById("actTypeInput");
const actAssistSelect   = document.getElementById("actAssistSelect");
const actDurationInput  = document.getElementById("actDurationInput");
const actToleranceSelect= document.getElementById("actToleranceSelect");
const actNotesInput     = document.getElementById("actNotesInput");
const actSaveBtn        = document.getElementById("actSaveBtn");
const actCancelBtn      = document.getElementById("actCancelBtn");
const actTableBody      = document.getElementById("actTableBody");
const exportActBtn      = document.getElementById("exportActBtn");

/* ========= DOM for Export All ========= */
const exportAllBtn = document.getElementById("exportAllBtn");

/* ========= Med chip data (quick-pick buttons) ========= */
let scheduledMeds = [
  { name: "Hydrocortisone 5 mg tab", category: "scheduled" },
  { name: "Omeprazole 20 mg cap", category: "scheduled" }
];
let prnMeds = [
  { name: "Acetaminophen 650 mg suppository", category: "prn" },
  { name: "Bisacodyl 10 mg suppository", category: "prn" },
  { name: "Hyoscyamine 0.125 mg ODT", category: "prn" },
  { name: "Lorazepam liquid 1 mg", category: "prn" },
  { name: "Morphine oral 0.5 mg (0.25 mL)", category: "prn" },
  { name: "Senna 8.6 mg tabs (2 tabs)", category: "prn" },
  { name: "Phenobarbital 60 mg tab", category: "prn" }
];

/* ========= Drawer helpers ========= */
function closeAllDrawers() {
      [formCard, medCard, oxyCard, mealCard, vitalsCard, sleepCard, actCard].forEach(el => {
    el.classList.remove("active");
  });
}

/* ========= Render chips for meds ========= */
function renderChips() {
  scheduledChipsDiv.innerHTML = "";
  scheduledMeds.forEach(m => {
    const btn = document.createElement("button");
    btn.className = "chip-btn";
    btn.textContent = m.name;
    btn.onclick = () => {
      medChosenName.value = m.name;
          medCategory.value = m.category;
    };
    scheduledChipsDiv.appendChild(btn);
  });

  prnChipsDiv.innerHTML = "";
  prnMeds.forEach(m => {
    const btn = document.createElement("button");
    btn.className = "chip-btn";
    btn.textContent = m.name;
    btn.onclick = () => {
      medChosenName.value = m.name;
          medCategory.value = m.category;
    };
    prnChipsDiv.appendChild(btn);
  });
}

/* ========= State for edit modes ========= */
let editOutputId = null;
let editMedId    = null;
let editOxyId    = null;
let editMealId   = null;
let editVitalId  = null;
let editSleepId  = null;
let editActId    = null;

    /* ========= RENDER TABLES (with Edit/Delete buttons) - XSS Safe ========= */
function renderOutputTable() {
  logTableBody.innerHTML = "";
      [...outputEntries].slice().sort((a, b) => b.time.localeCompare(a.time)).forEach(e => {
    const tr = document.createElement("tr");
        
        // Create cells safely to prevent XSS
        const cells = [
          ValidationService.sanitize(e.time || ""),
          ValidationService.sanitize(e.type || ""),
          ValidationService.sanitize(e.assist || ""),
          ValidationService.sanitize(e.amount || ""),
          ValidationService.sanitize(e.color || ""),
          ValidationService.sanitize(e.blood || ""),
          ValidationService.sanitize(e.pain || ""),
          ValidationService.sanitize(e.notes || "")
        ];
        
        cells.forEach(text => {
          const td = document.createElement("td");
          td.textContent = text;
          tr.appendChild(td);
        });
        
        // Actions cell
        const actionsCell = document.createElement("td");
        actionsCell.className = "actions-cell";
        
        const editBtn = document.createElement("button");
        editBtn.className = "sec-btn";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => editOutput(e.id);
        actionsCell.appendChild(editBtn);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "danger-btn";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteOutput(e.id);
        actionsCell.appendChild(deleteBtn);
        
        tr.appendChild(actionsCell);
    logTableBody.appendChild(tr);
  });
}

function renderMedTable() {
  medTableBody.innerHTML = "";
      [...medEntries].slice().sort((a, b) => b.time.localeCompare(a.time)).forEach(e => {
    const tr = document.createElement("tr");
        
        const cells = [
          ValidationService.sanitize(e.time || ""),
          ValidationService.sanitize(e.name || ""),
          ValidationService.sanitize(e.category || ""),
          ValidationService.sanitize(e.dose || ""),
          ValidationService.sanitize(e.reason || ""),
          ValidationService.sanitize(e.notes || "")
        ];
        
        cells.forEach(text => {
          const td = document.createElement("td");
          td.textContent = text;
          tr.appendChild(td);
        });
        
        const actionsCell = document.createElement("td");
        actionsCell.className = "actions-cell";
        
        const editBtn = document.createElement("button");
        editBtn.className = "sec-btn";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => editMed(e.id);
        actionsCell.appendChild(editBtn);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "danger-btn";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteMed(e.id);
        actionsCell.appendChild(deleteBtn);
        
        tr.appendChild(actionsCell);
    medTableBody.appendChild(tr);
  });
}

function renderOxyTable() {
  oxyTableBody.innerHTML = "";
      [...oxyEntries].slice().sort((a, b) => b.time.localeCompare(a.time)).forEach(e => {
    const tr = document.createElement("tr");
        
        const cells = [
          ValidationService.sanitize(e.time || ""),
          ValidationService.sanitize(`${e.flow || ""} / ${e.method || ""}`),
          ValidationService.sanitize(e.duration || ""),
          ValidationService.sanitize(e.reason || ""),
          ValidationService.sanitize(e.relief || "")
        ];
        
        cells.forEach(text => {
          const td = document.createElement("td");
          td.textContent = text;
          tr.appendChild(td);
        });
        
        const actionsCell = document.createElement("td");
        actionsCell.className = "actions-cell";
        
        const editBtn = document.createElement("button");
        editBtn.className = "sec-btn";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => editOxy(e.id);
        actionsCell.appendChild(editBtn);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "danger-btn";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteOxy(e.id);
        actionsCell.appendChild(deleteBtn);
        
        tr.appendChild(actionsCell);
    oxyTableBody.appendChild(tr);
  });
}

function renderMealTable() {
  mealTableBody.innerHTML = "";
      [...mealEntries].slice().sort((a, b) => b.time.localeCompare(a.time)).forEach(e => {
    const tr = document.createElement("tr");
        
        const cells = [
          ValidationService.sanitize(e.time || ""),
          ValidationService.sanitize(e.mealType || ""),
          ValidationService.sanitize(e.texture || ""),
          ValidationService.sanitize(e.portion || ""),
          ValidationService.sanitize(e.nausea || ""),
          ValidationService.sanitize(e.notes || "")
        ];
        
        cells.forEach(text => {
          const td = document.createElement("td");
          td.textContent = text;
          tr.appendChild(td);
        });
        
        const actionsCell = document.createElement("td");
        actionsCell.className = "actions-cell";
        
        const editBtn = document.createElement("button");
        editBtn.className = "sec-btn";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => editMeal(e.id);
        actionsCell.appendChild(editBtn);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "danger-btn";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteMeal(e.id);
        actionsCell.appendChild(deleteBtn);
        
        tr.appendChild(actionsCell);
    mealTableBody.appendChild(tr);
  });
}

function renderVitalTable() {
  vitalTableBody.innerHTML = "";
      [...vitalEntries].slice().sort((a, b) => b.time.localeCompare(a.time)).forEach(e => {
    const tr = document.createElement("tr");
        
        const cells = [
          ValidationService.sanitize(e.time || ""),
          ValidationService.sanitize(`${e.sys || ""}/${e.dia || ""}`),
          ValidationService.sanitize(e.pulse || ""),
          ValidationService.sanitize(e.rr || ""),
          ValidationService.sanitize(e.spO2 || ""),
          ValidationService.sanitize(e.position || ""),
          ValidationService.sanitize(e.timing || ""),
          ValidationService.sanitize(e.notes || "")
        ];
        
        cells.forEach(text => {
          const td = document.createElement("td");
          td.textContent = text;
          tr.appendChild(td);
        });
        
        const actionsCell = document.createElement("td");
        actionsCell.className = "actions-cell";
        
        const editBtn = document.createElement("button");
        editBtn.className = "sec-btn";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => editVital(e.id);
        actionsCell.appendChild(editBtn);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "danger-btn";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteVital(e.id);
        actionsCell.appendChild(deleteBtn);
        
        tr.appendChild(actionsCell);
    vitalTableBody.appendChild(tr);
  });
}

function renderSleepTable() {
  sleepTableBody.innerHTML = "";
      [...sleepEntries].slice().sort((a, b) => b.start.localeCompare(a.start)).forEach(e => {
    const tr = document.createElement("tr");
        
        const cells = [
          ValidationService.sanitize(e.start || ""),
          ValidationService.sanitize(e.end || ""),
          ValidationService.sanitize(e.total || ""),
          ValidationService.sanitize(e.quality || ""),
          ValidationService.sanitize(e.assist || ""),
          ValidationService.sanitize(e.notes || "")
        ];
        
        cells.forEach(text => {
          const td = document.createElement("td");
          td.textContent = text;
          tr.appendChild(td);
        });
        
        const actionsCell = document.createElement("td");
        actionsCell.className = "actions-cell";
        
        const editBtn = document.createElement("button");
        editBtn.className = "sec-btn";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => editSleep(e.id);
        actionsCell.appendChild(editBtn);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "danger-btn";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteSleep(e.id);
        actionsCell.appendChild(deleteBtn);
        
        tr.appendChild(actionsCell);
    sleepTableBody.appendChild(tr);
  });
}

function renderActTable() {
  actTableBody.innerHTML = "";
      [...actEntries].slice().sort((a, b) => b.time.localeCompare(a.time)).forEach(e => {
    const tr = document.createElement("tr");
        
        const cells = [
          ValidationService.sanitize(e.time || ""),
          ValidationService.sanitize(e.activity || ""),
          ValidationService.sanitize(e.assist || ""),
          ValidationService.sanitize(e.duration || ""),
          ValidationService.sanitize(e.tolerance || ""),
          ValidationService.sanitize(e.notes || "")
        ];
        
        cells.forEach(text => {
          const td = document.createElement("td");
          td.textContent = text;
          tr.appendChild(td);
        });
        
        const actionsCell = document.createElement("td");
        actionsCell.className = "actions-cell";
        
        const editBtn = document.createElement("button");
        editBtn.className = "sec-btn";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => editAct(e.id);
        actionsCell.appendChild(editBtn);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "danger-btn";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteAct(e.id);
        actionsCell.appendChild(deleteBtn);
        
        tr.appendChild(actionsCell);
    actTableBody.appendChild(tr);
  });
}

/* ========= EDIT / DELETE HANDLERS ========= */
/* Output */
window.editOutput = function(id) {
      const e = outputEntries.find(x => x.id === id);
      if (!e) return;
  editOutputId = id;
  closeAllDrawers();
      entryTypeLabel.textContent = e.type || "";
  dateTimeInput.value = e.time || nowLocalDatetimeValue();
  assistSelect.value = e.assist || "unassisted";
      amountInput.value = e.amount || "";
      colorInput.value = e.color || "";
      bloodSelect.value = e.blood || "no";
      painSelect.value = e.pain || "0";
      notesInput.value = e.notes || "";
  formCard.classList.add("active");
  saveOutputBtn.textContent = "Update Entry";
};

    window.deleteOutput = function(id) {
      if (!confirm("Delete this output entry?")) return;
      outputEntries = outputEntries.filter(x => x.id !== id);
      const result = DataService.saveArr("outputEntries", outputEntries);
      if (result.success) {
  renderOutputTable();
        DataService.showSuccess("Entry deleted");
      }
};

/* Meds */
window.editMed = function(id){
  const e = medEntries.find(x=>x.id===id);
  if(!e) return;
  editMedId = id;
  closeAllDrawers();
  medDateTimeInput.value = e.time || nowLocalDatetimeValue();
  medChosenName.value    = e.name || "";
  medCategory.value      = e.category || "";
  medDoseInput.value     = e.dose || "";
  medReasonInput.value   = e.reason || "";
  medNotesInput.value    = e.notes || "";
  medCard.classList.add("active");
  medSaveBtn.textContent = "Update Med Entry";
};
    window.deleteMed = function(id) {
      if (!confirm("Delete this medication entry?")) return;
      medEntries = medEntries.filter(x => x.id !== id);
      const result = DataService.saveArr("medEntries", medEntries);
      if (result.success) {
  renderMedTable();
        DataService.showSuccess("Medication entry deleted");
      }
};

/* Oxygen */
window.editOxy = function(id){
  const e = oxyEntries.find(x=>x.id===id);
  if(!e) return;
  editOxyId = id;
  closeAllDrawers();
  oxyDateTimeInput.value = e.time || nowLocalDatetimeValue();
  oxyFlowInput.value     = e.flow || "";
  oxyMethodSelect.value  = e.method || "Nasal cannula";
  oxyDurationInput.value = e.duration || "";
  oxyReasonInput.value   = e.reason || "";
  oxyReliefInput.value   = e.relief || "";
  oxyCard.classList.add("active");
  oxySaveBtn.textContent = "Update Oxygen Entry";
};
    window.deleteOxy = function(id) {
      if (!confirm("Delete this oxygen entry?")) return;
      oxyEntries = oxyEntries.filter(x => x.id !== id);
      const result = DataService.saveArr("oxyEntries", oxyEntries);
      if (result.success) {
  renderOxyTable();
        DataService.showSuccess("Oxygen entry deleted");
      }
};

/* Meals */
    window.editMeal = function(id) {
      const e = mealEntries.find(x => x.id === id);
      if (!e) return;
  editMealId = id;
  closeAllDrawers();
  mealDateTimeInput.value = e.time || nowLocalDatetimeValue();
      mealTypeSelect.value = e.mealType || "Dinner";
  mealTextureSelect.value = e.texture || "Regular";
  mealPercentSelect.value = e.portion || "0%";
      mealNauseaSelect.value = e.nausea || "No";
      mealNotesInput.value = e.notes || "";
  mealCard.classList.add("active");
  mealSaveBtn.textContent = "Update Meal Entry";
};

    window.deleteMeal = function(id) {
      if (!confirm("Delete this meal entry?")) return;
      mealEntries = mealEntries.filter(x => x.id !== id);
      const result = DataService.saveArr("mealEntries", mealEntries);
      if (result.success) {
  renderMealTable();
        DataService.showSuccess("Meal entry deleted");
      }
};

/* Vitals */
    window.editVital = function(id) {
      const e = vitalEntries.find(x => x.id === id);
      if (!e) return;
  editVitalId = id;
  closeAllDrawers();
  vitalDateTimeInput.value = e.time || nowLocalDatetimeValue();
      vitalSysInput.value = e.sys || "";
      vitalDiaInput.value = e.dia || "";
      vitalPulseInput.value = e.pulse || "";
      vitalRRInput.value = e.rr || "";
      vitalSpO2Input.value = e.spO2 || "";
      vitalPosSelect.value = e.position || "Sitting";
  vitalFastingSelect.value = e.timing || "Fasting / before meal";
      vitalNotesInput.value = e.notes || "";
  vitalsCard.classList.add("active");
  vitalSaveBtn.textContent = "Update Vitals Entry";
};

    window.deleteVital = function(id) {
      if (!confirm("Delete this vitals entry?")) return;
      vitalEntries = vitalEntries.filter(x => x.id !== id);
      const result = DataService.saveArr("vitalEntries", vitalEntries);
      if (result.success) {
  renderVitalTable();
        DataService.showSuccess("Vitals entry deleted");
      }
};

/* Sleep */
    window.editSleep = function(id) {
      const e = sleepEntries.find(x => x.id === id);
      if (!e) return;
  editSleepId = id;
  closeAllDrawers();
      sleepStartInput.value = e.start || nowLocalDatetimeValue();
      sleepEndInput.value = e.end || "";
      sleepTotalInput.value = e.total || "";
  sleepQualitySelect.value = e.quality || "Good / mostly calm";
      sleepAssistSelect.value = e.assist || "No help needed";
      sleepNotesInput.value = e.notes || "";
  sleepCard.classList.add("active");
  sleepSaveBtn.textContent = "Update Sleep Entry";
};

    window.deleteSleep = function(id) {
      if (!confirm("Delete this sleep entry?")) return;
      sleepEntries = sleepEntries.filter(x => x.id !== id);
      const result = DataService.saveArr("sleepEntries", sleepEntries);
      if (result.success) {
  renderSleepTable();
        DataService.showSuccess("Sleep entry deleted");
      }
};

/* Activity */
    window.editAct = function(id) {
      const e = actEntries.find(x => x.id === id);
      if (!e) return;
  editActId = id;
  closeAllDrawers();
      actDateTimeInput.value = e.time || nowLocalDatetimeValue();
      actTypeInput.value = e.activity || "";
      actAssistSelect.value = e.assist || "Independent";
      actDurationInput.value = e.duration || "";
  actToleranceSelect.value = e.tolerance || "Okay";
      actNotesInput.value = e.notes || "";
  actCard.classList.add("active");
      actSaveBtn.textContent = "Update Activity Entry";
    };

    window.deleteAct = function(id) {
      if (!confirm("Delete this activity entry?")) return;
      actEntries = actEntries.filter(x => x.id !== id);
      const result = DataService.saveArr("actEntries", actEntries);
      if (result.success) {
  renderActTable();
        DataService.showSuccess("Activity entry deleted");
      }
};

/* ========= NEW ENTRY HANDLERS ========= */
/* OUTPUT new */
let currentOutputType = "";
    urineBtn.addEventListener("click", () => {
  closeAllDrawers();
  editOutputId = null;
  currentOutputType = "urine";
  entryTypeLabel.textContent = "Urine";
  dateTimeInput.value = nowLocalDatetimeValue();
  assistSelect.value = "unassisted";
      amountInput.value = "";
      colorInput.value = "";
      bloodSelect.value = "no";
      painSelect.value = "0";
      notesInput.value = "";
  formCard.classList.add("active");
  saveOutputBtn.textContent = "Save Entry";
});

    stoolBtn.addEventListener("click", () => {
  closeAllDrawers();
  editOutputId = null;
  currentOutputType = "stool";
  entryTypeLabel.textContent = "Stool";
  dateTimeInput.value = nowLocalDatetimeValue();
  assistSelect.value = "unassisted";
      amountInput.value = "";
      colorInput.value = "";
      bloodSelect.value = "no";
      painSelect.value = "0";
      notesInput.value = "";
  formCard.classList.add("active");
  saveOutputBtn.textContent = "Save Entry";
});

    cancelOutputBtn.addEventListener("click", () => {
  formCard.classList.remove("active");
});

    saveOutputBtn.addEventListener("click", () => {
      // Validate datetime
      const dateValidation = ValidationService.validateDateTime(dateTimeInput.value, true);
      if (!dateValidation.isValid) {
        DataService.showError(dateValidation.error);
        return;
      }

  const newData = {
    id: editOutputId || newId(),
        time: dateTimeInput.value,
        type: currentOutputType || entryTypeLabel.textContent || "",
    assist: assistSelect.value,
        amount: amountInput.value.trim(),
        color: colorInput.value.trim(),
        blood: bloodSelect.value,
        pain: painSelect.value,
        notes: notesInput.value.trim()
      };

      if (editOutputId) {
        outputEntries = outputEntries.map(x => x.id === editOutputId ? newData : x);
  } else {
    outputEntries.push(newData);
  }
      
      const result = DataService.saveArr("outputEntries", outputEntries);
      if (result.success) {
  renderOutputTable();
  formCard.classList.remove("active");
        DataService.showSuccess("Output entry saved");
      }
});

/* MEDS new */
openMedBtn.addEventListener("click", ()=>{
  closeAllDrawers();
  editMedId = null;
  medDateTimeInput.value = nowLocalDatetimeValue();
  medChosenName.value    = "";
  medCategory.value      = "";
  medDoseInput.value     = "";
  medReasonInput.value   = "";
  medNotesInput.value    = "";
  medCard.classList.add("active");
  medSaveBtn.textContent = "Save Med Entry";
});
medCancelBtn.addEventListener("click", ()=>{
  medCard.classList.remove("active");
});
    medSaveBtn.addEventListener("click", () => {
      // Validate medication entry
      const validation = ValidationService.validateMedication(
        medChosenName.value,
        medDoseInput.value,
        medDateTimeInput.value,
        medEntries.filter(e => e.id !== editMedId) // Exclude current entry if editing
      );

      // Show errors - block save if critical
      if (validation.errors.length > 0) {
        validation.errors.forEach(err => DataService.showError(err));
        return;
      }

      // Show warnings but allow save
      if (validation.warnings.length > 0) {
        validation.warnings.forEach(warn => DataService.showWarning(warn));
      }

  const newData = {
    id: editMedId || newId(),
        time: medDateTimeInput.value,
        name: medChosenName.value.trim(),
        category: medCategory.value.trim(),
        dose: medDoseInput.value.trim(),
        reason: medReasonInput.value.trim(),
        notes: medNotesInput.value.trim()
      };

      if (editMedId) {
        medEntries = medEntries.map(x => x.id === editMedId ? newData : x);
  } else {
    medEntries.push(newData);
  }

      const result = DataService.saveArr("medEntries", medEntries);
      if (result.success) {
  renderMedTable();
  medCard.classList.remove("active");
        DataService.showSuccess("Medication entry saved");
      }
});
addMedNameBtn.addEventListener("click", ()=>{
  const custom = prompt("Medication name?");
  if(custom) {
    prnMeds.push({name: custom, category:"prn"});
    renderChips();
  }
});

/* OXYGEN new */
openOxyBtn.addEventListener("click", ()=>{
  closeAllDrawers();
  editOxyId = null;
  oxyDateTimeInput.value = nowLocalDatetimeValue();
  oxyFlowInput.value     = "";
  oxyMethodSelect.value  = "Nasal cannula";
  oxyDurationInput.value = "";
  oxyReasonInput.value   = "";
  oxyReliefInput.value   = "";
  oxyCard.classList.add("active");
  oxySaveBtn.textContent = "Save Oxygen Entry";
});
oxyCancelBtn.addEventListener("click", ()=>{
  oxyCard.classList.remove("active");
});
    oxySaveBtn.addEventListener("click", () => {
      const dateValidation = ValidationService.validateDateTime(oxyDateTimeInput.value, true);
      if (!dateValidation.isValid) {
        DataService.showError(dateValidation.error);
        return;
      }

      const newData = {
        id: editOxyId || newId(),
        time: oxyDateTimeInput.value,
        flow: oxyFlowInput.value.trim(),
        method: oxyMethodSelect.value,
        duration: oxyDurationInput.value.trim(),
        reason: oxyReasonInput.value.trim(),
        relief: oxyReliefInput.value.trim()
      };

      if (editOxyId) {
        oxyEntries = oxyEntries.map(x => x.id === editOxyId ? newData : x);
      } else {
        oxyEntries.push(newData);
      }

      const result = DataService.saveArr("oxyEntries", oxyEntries);
      if (result.success) {
        renderOxyTable();
        oxyCard.classList.remove("active");
        DataService.showSuccess("Oxygen entry saved");
      }
    });

/* MEALS new */
openMealBtn.addEventListener("click", ()=>{
  closeAllDrawers();
  editMealId = null;
  mealDateTimeInput.value = nowLocalDatetimeValue();
  mealTypeSelect.value    = "Dinner";
  mealTextureSelect.value = "Regular";
  mealPercentSelect.value = "0%";
  mealNauseaSelect.value  = "No";
  mealNotesInput.value    = "";
  mealCard.classList.add("active");
  mealSaveBtn.textContent = "Save Meal Entry";
});
mealCancelBtn.addEventListener("click", ()=>{
  mealCard.classList.remove("active");
});
    mealSaveBtn.addEventListener("click", () => {
      const dateValidation = ValidationService.validateDateTime(mealDateTimeInput.value, true);
      if (!dateValidation.isValid) {
        DataService.showError(dateValidation.error);
        return;
      }

      const newData = {
        id: editMealId || newId(),
        time: mealDateTimeInput.value,
        mealType: mealTypeSelect.value,
        texture: mealTextureSelect.value,
        portion: mealPercentSelect.value,
        nausea: mealNauseaSelect.value,
        notes: mealNotesInput.value.trim()
      };

      if (editMealId) {
        mealEntries = mealEntries.map(x => x.id === editMealId ? newData : x);
      } else {
        mealEntries.push(newData);
      }

      const result = DataService.saveArr("mealEntries", mealEntries);
      if (result.success) {
        renderMealTable();
        mealCard.classList.remove("active");
        DataService.showSuccess("Meal entry saved");
      }
    });

/* VITALS new */
openVitalBtn.addEventListener("click", ()=>{
  closeAllDrawers();
  editVitalId = null;
  vitalDateTimeInput.value = nowLocalDatetimeValue();
  vitalSysInput.value      = "";
  vitalDiaInput.value      = "";
  vitalPulseInput.value    = "";
  vitalRRInput.value       = "";
  vitalSpO2Input.value     = "";
  vitalPosSelect.value     = "Sitting";
  vitalFastingSelect.value = "Fasting / before meal";
  vitalNotesInput.value    = "";
  vitalsCard.classList.add("active");
  vitalSaveBtn.textContent = "Save Vitals Entry";
});
vitalCancelBtn.addEventListener("click", ()=>{
  vitalsCard.classList.remove("active");
});
    vitalSaveBtn.addEventListener("click", () => {
      // Validate datetime
      const dateValidation = ValidationService.validateDateTime(vitalDateTimeInput.value, true);
      if (!dateValidation.isValid) {
        DataService.showError(dateValidation.error);
        return;
      }

      // Validate vitals
      const vitalValidation = ValidationService.validateVitals(
        vitalSysInput.value,
        vitalDiaInput.value,
        vitalPulseInput.value,
        vitalRRInput.value,
        vitalSpO2Input.value
      );

      // Show critical errors - require confirmation
      if (vitalValidation.errors.length > 0) {
        const criticalMsg = vitalValidation.errors.join("\n") + 
          "\n\nDo you still want to save this entry?";
        if (!confirm(criticalMsg)) {
          return;
        }
        // Still show the errors
        vitalValidation.errors.forEach(err => DataService.showError(err));
      }

      // Show warnings
      if (vitalValidation.warnings.length > 0) {
        vitalValidation.warnings.forEach(warn => DataService.showWarning(warn));
      }

  const newData = {
    id: editVitalId || newId(),
    time: vitalDateTimeInput.value,
        sys: vitalSysInput.value.trim(),
        dia: vitalDiaInput.value.trim(),
        pulse: vitalPulseInput.value.trim(),
        rr: vitalRRInput.value.trim(),
        spO2: vitalSpO2Input.value.trim(),
    position: vitalPosSelect.value,
        timing: vitalFastingSelect.value,
        notes: vitalNotesInput.value.trim()
  };

      if (editVitalId) {
        vitalEntries = vitalEntries.map(x => x.id === editVitalId ? newData : x);
  } else {
    vitalEntries.push(newData);
  }

      const result = DataService.saveArr("vitalEntries", vitalEntries);
      if (result.success) {
  renderVitalTable();
  vitalsCard.classList.remove("active");
        DataService.showSuccess("Vitals entry saved");
      }
});

/* SLEEP new */
openSleepBtn.addEventListener("click", ()=>{
  closeAllDrawers();
  editSleepId = null;
  sleepStartInput.value    = nowLocalDatetimeValue();
  sleepEndInput.value      = "";
  sleepTotalInput.value    = "";
  sleepQualitySelect.value = "Good / mostly calm";
  sleepAssistSelect.value  = "No help needed";
  sleepNotesInput.value    = "";
  sleepCard.classList.add("active");
  sleepSaveBtn.textContent = "Save Sleep Entry";
});
sleepCancelBtn.addEventListener("click", ()=>{
  sleepCard.classList.remove("active");
});
    sleepSaveBtn.addEventListener("click", () => {
      const startValidation = ValidationService.validateDateTime(sleepStartInput.value, true);
      if (!startValidation.isValid) {
        DataService.showError("Start time: " + startValidation.error);
        return;
      }

      if (sleepEndInput.value) {
        const endValidation = ValidationService.validateDateTime(sleepEndInput.value, true);
        if (!endValidation.isValid) {
          DataService.showError("End time: " + endValidation.error);
          return;
        }
      }

      const newData = {
        id: editSleepId || newId(),
        start: sleepStartInput.value,
        end: sleepEndInput.value,
        total: sleepTotalInput.value.trim(),
        quality: sleepQualitySelect.value,
        assist: sleepAssistSelect.value,
        notes: sleepNotesInput.value.trim()
      };

      if (editSleepId) {
        sleepEntries = sleepEntries.map(x => x.id === editSleepId ? newData : x);
      } else {
        sleepEntries.push(newData);
      }

      const result = DataService.saveArr("sleepEntries", sleepEntries);
      if (result.success) {
        renderSleepTable();
        sleepCard.classList.remove("active");
        DataService.showSuccess("Sleep entry saved");
      }
    });

/* ACTIVITY new */
openActBtn.addEventListener("click", ()=>{
  closeAllDrawers();
  editActId = null;
  actDateTimeInput.value   = nowLocalDatetimeValue();
  actTypeInput.value       = "";
  actAssistSelect.value    = "Independent";
  actDurationInput.value   = "";
  actToleranceSelect.value = "Okay";
  actNotesInput.value      = "";
  actCard.classList.add("active");
  actSaveBtn.textContent   = "Save Activity Entry";
});
actCancelBtn.addEventListener("click", ()=>{
  actCard.classList.remove("active");
});
    actSaveBtn.addEventListener("click", () => {
      const dateValidation = ValidationService.validateDateTime(actDateTimeInput.value, true);
      if (!dateValidation.isValid) {
        DataService.showError(dateValidation.error);
        return;
      }

      const newData = {
        id: editActId || newId(),
        time: actDateTimeInput.value,
        activity: actTypeInput.value.trim(),
        assist: actAssistSelect.value,
        duration: actDurationInput.value.trim(),
        tolerance: actToleranceSelect.value,
        notes: actNotesInput.value.trim()
      };

      if (editActId) {
        actEntries = actEntries.map(x => x.id === editActId ? newData : x);
      } else {
        actEntries.push(newData);
      }

      const result = DataService.saveArr("actEntries", actEntries);
      if (result.success) {
        renderActTable();
        actCard.classList.remove("active");
        DataService.showSuccess("Activity entry saved");
      }
    });

/* ========= CSV EXPORT HELPERS ========= */
    function csvEscape(v) {
      return `"${(v ?? "").toString().replace(/"/g, '""')}"`;
}

    function exportSectionCSV(fnameBase, headerLabelRow, headers, rows, mapFn) {
  const ts = fileStamp();
  const filename = `${fnameBase}_as_of_${ts}.csv`;

  const csvLines = [];
  csvLines.push(csvEscape(headerLabelRow));
  csvLines.push(""); // blank line
      csvLines.push(headers.map(h => csvEscape(h)).join(","));

      rows.forEach(r => {
    const mapped = mapFn(r);
        const line = headers.map(h => csvEscape(mapped[h] ?? "")).join(",");
    csvLines.push(line);
  });

      const blob = new Blob([csvLines.join("\n")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

/* Per-section export buttons */
exportOutputBtn.addEventListener("click", ()=>{
  const rows = [...outputEntries].slice().sort((a,b)=>b.time.localeCompare(a.time));
  exportSectionCSV(
    "output_log",
    `Output log export as of ${niceNowStamp()}`,
    [
      "Logged Time",
      "Type (urine/stool)",
      "Assist Level",
      "Amount",
      "Color / Appearance",
      "Blood Seen",
      "Pain/Strain (0-10)",
      "Notes"
    ],
    rows,
    r=>({
      "Logged Time": r.time,
      "Type (urine/stool)": r.type,
      "Assist Level": r.assist,
      "Amount": r.amount,
      "Color / Appearance": r.color,
      "Blood Seen": r.blood,
      "Pain/Strain (0-10)": r.pain,
      "Notes": r.notes
    })
  );
});

exportMedBtn.addEventListener("click", ()=>{
  const rows = [...medEntries].slice().sort((a,b)=>b.time.localeCompare(a.time));
  exportSectionCSV(
    "med_log",
    `Medication log export as of ${niceNowStamp()}`,
    [
      "Logged Time",
      "Medication",
      "Category",
      "Dose / Route",
      "Reason",
      "Notes / Effect"
    ],
    rows,
    r=>({
      "Logged Time": r.time,
      "Medication": r.name,
      "Category": r.category,
      "Dose / Route": r.dose,
      "Reason": r.reason,
      "Notes / Effect": r.notes
    })
  );
});

exportOxyBtn.addEventListener("click", ()=>{
  const rows = [...oxyEntries].slice().sort((a,b)=>b.time.localeCompare(a.time));
  exportSectionCSV(
    "oxygen_log",
    `Oxygen log export as of ${niceNowStamp()}`,
    [
      "Start Time",
      "Flow (L/min)",
      "Method",
      "Duration (min)",
      "Reason",
      "Relief / Effect"
    ],
    rows,
    r=>({
      "Start Time": r.time,
      "Flow (L/min)": r.flow,
      "Method": r.method,
      "Duration (min)": r.duration,
      "Reason": r.reason,
      "Relief / Effect": r.relief
    })
  );
});

exportMealBtn.addEventListener("click", ()=>{
  const rows = [...mealEntries].slice().sort((a,b)=>b.time.localeCompare(a.time));
  exportSectionCSV(
    "meals_log",
    `Meals / intake export as of ${niceNowStamp()}`,
    [
      "Time",
      "Meal",
      "Texture",
      "Portion Eaten",
      "Nausea/Vomit",
      "Notes"
    ],
    rows,
    r=>({
      "Time": r.time,
      "Meal": r.mealType,
      "Texture": r.texture,
      "Portion Eaten": r.portion,
      "Nausea/Vomit": r.nausea,
      "Notes": r.notes
    })
  );
});

exportVitalBtn.addEventListener("click", ()=>{
  const rows = [...vitalEntries].slice().sort((a,b)=>b.time.localeCompare(a.time));
  exportSectionCSV(
    "vitals_log",
    `Vitals export as of ${niceNowStamp()}`,
    [
      "Time",
      "BP Systolic",
      "BP Diastolic",
      "Pulse",
      "Resp Rate",
      "SpO2 %",
      "Position",
      "Timing",
      "Notes"
    ],
    rows,
    r=>({
      "Time": r.time,
      "BP Systolic": r.sys,
      "BP Diastolic": r.dia,
      "Pulse": r.pulse,
      "Resp Rate": r.rr,
      "SpO2 %": r.spO2,
      "Position": r.position,
      "Timing": r.timing,
      "Notes": r.notes
    })
  );
});

exportSleepBtn.addEventListener("click", ()=>{
  const rows = [...sleepEntries].slice().sort((a,b)=>b.start.localeCompare(a.start));
  exportSectionCSV(
    "sleep_log",
    `Sleep / rest export as of ${niceNowStamp()}`,
    [
      "Start Time",
      "End Time",
      "Total (hrs)",
      "Quality",
      "Assist / Meds",
      "Notes"
    ],
    rows,
    r=>({
      "Start Time": r.start,
      "End Time": r.end,
      "Total (hrs)": r.total,
      "Quality": r.quality,
      "Assist / Meds": r.assist,
      "Notes": r.notes
    })
  );
});

exportActBtn.addEventListener("click", ()=>{
  const rows = [...actEntries].slice().sort((a,b)=>b.time.localeCompare(a.time));
  exportSectionCSV(
    "activity_log",
    `Activity / mobility export as of ${niceNowStamp()}`,
    [
      "Time",
      "Activity",
      "Assist",
      "Duration (min)",
      "Tolerance",
      "Notes"
    ],
    rows,
    r=>({
      "Time": r.time,
      "Activity": r.activity,
      "Assist": r.assist,
      "Duration (min)": r.duration,
      "Tolerance": r.tolerance,
      "Notes": r.notes
    })
  );
});

/* ========= EXPORT ALL SUMMARY ========= */
    function buildSummaryRows() {
  let summary = [];

      outputEntries.forEach(r => {
    summary.push({
      t: r.time || "",
      category: "Output",
          summary: `${r.type || ""} ${r.amount || ""} ${r.color || ""} assist:${r.assist || ""} pain:${r.pain || ""} blood:${r.blood || ""}`,
          notes: r.notes || ""
    });
  });

      medEntries.forEach(r => {
    summary.push({
      t: r.time || "",
      category: "Medication",
          summary: `${r.name || ""} (${r.category || ""}) ${r.dose || ""} for ${r.reason || ""}`,
          notes: r.notes || ""
    });
  });

      oxyEntries.forEach(r => {
    summary.push({
      t: r.time || "",
      category: "Oxygen",
          summary: `${r.flow || ""} L/min ${r.method || ""} x${r.duration || ""}min for ${r.reason || ""}`,
          notes: r.relief || ""
    });
  });

      mealEntries.forEach(r => {
    summary.push({
      t: r.time || "",
      category: "Meal",
          summary: `${r.mealType || ""}, ${r.texture || ""}, ate ${r.portion || ""}, nausea:${r.nausea || ""}`,
          notes: r.notes || ""
    });
  });

      vitalEntries.forEach(r => {
    summary.push({
      t: r.time || "",
      category: "Vitals",
          summary: `BP ${r.sys || ""}/${r.dia || ""}, HR ${r.pulse || ""}, RR ${r.rr || ""}, SpO2 ${r.spO2 || ""}, ${r.position || ""}, ${r.timing || ""}`,
          notes: r.notes || ""
    });
  });

      sleepEntries.forEach(r => {
    summary.push({
      t: r.start || "",
      category: "Sleep",
          summary: `${r.total || ""} hrs, quality:${r.quality || ""}, assist:${r.assist || ""}`,
          notes: r.notes || `(end ${r.end || ""})`
    });
  });

      actEntries.forEach(r => {
    summary.push({
      t: r.time || "",
      category: "Activity",
          summary: `${r.activity || ""}, assist:${r.assist || ""}, ${r.duration || ""} min, tol:${r.tolerance || ""}`,
          notes: r.notes || ""
    });
  });

  // sort ascending by time-ish string
      summary.sort((a, b) => (a.t || "").localeCompare(b.t || ""));
  return summary;
}

    exportAllBtn.addEventListener("click", () => {
  const rows = buildSummaryRows();
  const ts = fileStamp();
  const filename = `care_summary_as_of_${ts}.csv`;

  const csvLines = [];
  csvLines.push(csvEscape(`Full care summary export as of ${niceNowStamp()}`));
  csvLines.push("");
      csvLines.push(["Time", "Category", "Summary", "Notes"]
        .map(h => csvEscape(h)).join(","));

      rows.forEach(r => {
    const line = [
      csvEscape(r.t),
      csvEscape(r.category),
      csvEscape(r.summary),
      csvEscape(r.notes)
    ].join(",");
    csvLines.push(line);
  });

      const blob = new Blob([csvLines.join("\n")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
});

/* ========= Initial render ========= */
renderChips();
renderOutputTable();
renderMedTable();
renderOxyTable();
renderMealTable();
renderVitalTable();
renderSleepTable();
renderActTable();
</script>

</body>
</html>
